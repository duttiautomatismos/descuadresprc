<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PICKING DESCUADRES RFID (Firebase ¬∑ Auto‚ÄëSync SEGURO)</title>
  <style>
    :root{ --bg:#0f172a; --panel:#1a2335; --panel-2:#0b1224; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --chip:#1f2937; --input-bg:#ffffff; --border:#374151; --shadow: 0 10px 30px rgba(0,0,0,.45); --radius:18px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif; background: radial-gradient(1200px 600px at 70% -10%, #0b1b3f 0%, var(--bg) 60%); color:var(--text); }
    .container{max-width:1200px;margin:0 auto;padding:24px;}
    h1{font-size:clamp(24px,2.8vw,36px);margin:0 0 12px 0;letter-spacing:.5px}
    .subtle{color:var(--muted);font-size:14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:18px 0 22px}
    .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1c2642,#121a30); color:var(--text);padding:10px 14px;border-radius:14px;cursor:pointer;box-shadow:var(--shadow); transition: transform .05s ease, background .2s ease, border-color .2s ease; font-weight:600;}
    .btn:hover{transform:translateY(-1px);border-color:#4b5563}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:linear-gradient(180deg,#475569,#374151);} 
    .surface{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04)); border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow); margin-bottom: 20px; }
    .file-note{margin-top:8px;min-height:24px}
    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:18px 0}
    .card{padding:16px;border-radius:16px;background:radial-gradient(400px 180px at 10% -10%, rgba(59,130,246,.15), rgba(255,255,255,.03)); border:1px solid var(--border)}
    .metric{font-size:28px;font-weight:800}
    .metric .tiny{font-size:13px;color:var(--muted);font-weight:600;margin-left:6px}
    .section{margin:28px 0;padding:18px}
    .section h2{margin:0 0 12px 0;font-size:22px}
    .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;color:var(--muted)}
    input[type="text"], select, .sku-select{ padding:11px 12px;border-radius:12px;border:1px solid #d1d5db; background: var(--input-bg); color: #111827; font-size:14px; outline:none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input[type="text"]:focus, select:focus, .sku-select:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.2) }
    .sku-input-container { position: relative; display: inline-block; width: 100%; }
    .sku-input-formatted { position: absolute; top: 11px; left: 12px; pointer-events: none; color: #6b7280; font-size: 14px; font-family: monospace; letter-spacing: 1px; z-index: 1; }
    .sku-input-raw { background: transparent !important; color: #111827 !important; caret-color: #111827; position: relative; z-index: 2; font-family: monospace; letter-spacing: 1px; }
    .sku-input-raw::placeholder { color: transparent; }
    .search-input{ background: var(--input-bg) !important; color:#111827; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.15) inset }
    .clear-buttons { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .clear-btn { padding: 8px 12px; font-size: 12px; }
    .row-comment, .tsa-comment{ background: #f9fafb; border:1px solid #e5e7eb; color:#374151; padding: 8px 10px; border-radius: 8px; width: 100%; }
    .sku-results table, .repaso table{width:100%;border-collapse:collapse}
    .sku-results th, .sku-results td, .repaso th, .repaso td{padding:10px;border-bottom:1px solid #374151}
    .sku-results th, .repaso th{color:#cbd5e1;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    .row-ok{opacity:.6}
    .row-ok .tag{background:#0b3b1f;color:#86efac;border-color:#14532d}
    .tsa-block{margin:12px 0 18px;border:1px dashed #374151;border-radius:14px;overflow:hidden}
    .tsa-head{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px 14px;background:#0d1428}
    .tsa-title{display:flex;align-items:center;gap:10px}
    .tsa-title h3{margin:0;font-size:18px;font-weight:600}
    .tsa-controls{display:flex;align-items:center;gap:10px}
    .tsa-controls input[type="text"]{min-width:240px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#1e293b;border:1px solid #374151}
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 14px}
    .filters .field{min-width:160px}
    .danger-zone{display:flex;flex-wrap:wrap;align-items:center;gap:14px;margin-top:14px;padding:14px;border:1px dashed #3b1d1d;border-radius:14px;background: radial-gradient(600px 200px at 100% -40%, rgba(239,68,68,.2), transparent)}
    .danger-zone .countdown{min-width:120px;color:#fecaca}
    input[type="range"]{width:240px}
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    #managingTitle{ font-size:18px; font-weight:600; color:var(--text) !important; margin-bottom: 10px; }
    .tri-state-checkbox { width: 18px; height: 18px; border-radius: 3px; border: 2px solid #6b7280; background-color: transparent; cursor: pointer; position: relative; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .tri-state-checkbox.state-0 { background-color: transparent; border-color: #6b7280; }
    .tri-state-checkbox.state-1 { background-color: #f59e0b; border-color: #f59e0b; }
    .tri-state-checkbox.state-1::after { content: "‚ö†"; font-size: 10px; color: #000; font-weight: bold; }
    .tri-state-checkbox.state-2 { background-color: #22c55e; border-color: #22c55e; }
    .tri-state-checkbox.state-2::after { content: "‚úì"; font-size: 12px; color: white; font-weight: bold; }
    .tsa-toggle-btn { padding: 8px 16px; border-radius: 10px; border: 1px solid #374151; background: linear-gradient(180deg, #1c2642, #121a30); color: var(--text); cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; min-width: 100px; justify-content: center; }
    .tsa-toggle-btn:hover { transform: translateY(-1px); border-color: #4b5563; }
    .tsa-toggle-btn.state-0 { background: linear-gradient(180deg, #1c2642, #121a30); }
    .tsa-toggle-btn.state-1 { background: linear-gradient(180deg, #f59e0b, #d97706); color: #0a0a0a; }
    .tsa-toggle-btn.state-2 { background: linear-gradient(180deg, #16a34a, #15803d); }
    .tsa-toggle-btn.mixed { background: linear-gradient(180deg, #6b7280, #4b5563); }
    @media (max-width:900px){ .summary{grid-template-columns:1fr} .grid-two{grid-template-columns:1fr} .tsa-controls{flex-direction:column;align-items:flex-start} .clear-buttons{flex-direction:column;} .clear-buttons .btn{width:100%;}}
    #btnImport,#btnSave{display:none !important}
  </style>
</head>
<body>
  <div class="container">
    <h1>PICKING DESCUADRES RFID</h1>

    <div class="toolbar">
      <button id="btnSaveAs" class="btn">üìù Exportar .txt‚Ä¶</button>
    </div>
    <div id="fileNote" class="file-note subtle">Fuente: Firebase Realtime Database (<code>actual</code>) ‚Äî <b>Auto‚Äësync</b></div>

    <section id="afterImport">
      <div class="surface section">
        <div id="managingTitle" class="subtle"></div>
        <div class="summary">
          <div class="card"><div class="metric" id="m_tsa">0 <span class="tiny">tsa's pendientes</span></div></div>
          <div class="card"><div class="metric" id="m_sku">0 <span class="tiny">sku's pendientes</span></div></div>
          <div class="card"><div class="metric" id="m_units">0 <span class="tiny">unidades pendientes</span></div></div>
        </div>
      </div>

      <div class="surface section">
        <h2>PICKING SKU</h2>
        <div class="grid-two">
          <div class="field">
            <label for="skuSearch">Escanea o escribe un SKU</label>
            <div class="sku-input-container">
              <input id="skuSearch" class="search-input sku-input-raw" type="text" inputmode="numeric" maxlength="14" autocomplete="off" />
              <div id="skuFormattedDisplay" class="sku-input-formatted">0/____/___/___/__</div>
            </div>
            <div class="clear-buttons"><button id="btnClearSku" class="btn secondary clear-btn">üóëÔ∏è Limpiar SKU</button></div>
          </div>
          <div class="field">
            <label>SKU's pendientes</label>
            <select id="pendingSkuSelect" class="sku-select"><option value="">Selecciona un SKU pendiente...</option></select>
          </div>
        </div>
        <div id="skuResults" class="sku-results" style="margin-top:14px"></div>
      </div>

      <div class="surface section">
        <h2>REPASO TOTALES</h2>
        <div class="filters">
          <div class="field"><label for="f_t">Tienda</label><input id="f_t" type="text" placeholder="" /></div>
          <div class="field"><label for="f_s">Secci√≥n</label><select id="f_s"><option value="">Todas</option><option value="1">1 ‚Äì Se√±ora</option><option value="2">2 ‚Äì Caballero</option></select></div>
          <div class="field"><label for="f_a">Aparte</label><input id="f_a" type="text" placeholder="" /></div>
        </div>
        <div class="clear-buttons"><button id="btnClearFilters" class="btn secondary clear-btn">üóëÔ∏è Limpiar filtros</button></div>
        <div id="repaso" class="repaso"></div>

        <div class="danger-zone">
          <div class="field" style="min-width:260px"><label for="resetSlider">Desliza hasta 100 para desbloquear RESET de la columna <code>ok</code> (no borra comentarios)</label><input id="resetSlider" type="range" min="0" max="100" value="0" step="1" /></div>
          <button id="btnReset" class="btn warn" disabled>üîÅ Resetear columna OK</button>
          <div class="countdown" id="resetCountdown"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    const POLL_MS = 5000; // refresco

    const state = { rows: [], filename: null, map: new Map(), lastHash: null };

    // ===== Firebase REST config =====
    const DB_BASE = "https://prc-descuadre-rfid-default-rtdb.firebaseio.com"; // rtdb!
    const NODE = "actual"; // nodo √∫nico
    const DB_URL = `${DB_BASE}/${NODE}`;

    // UI ELEMENTS
    const fileNote = $('#fileNote');
    const managingTitle = $('#managingTitle');
    const m_tsa = $('#m_tsa');
    const m_sku = $('#m_sku');
    const m_units = $('#m_units');

    const btnSaveAs = $('#btnSaveAs');

    const skuSearch = $('#skuSearch');
    const skuFormattedDisplay = $('#skuFormattedDisplay');
    const pendingSkuSelect = $('#pendingSkuSelect');
    const skuResults = $('#skuResults');
    const btnClearSku = $('#btnClearSku');

    const f_t = $('#f_t');
    const f_s = $('#f_s');
    const f_a = $('#f_a');
    const repaso = $('#repaso');
    const btnClearFilters = $('#btnClearFilters');

    const resetSlider = $('#resetSlider');
    const btnReset = $('#btnReset');
    const resetCountdown = $('#resetCountdown');

    // ======== REST helpers (con Content-Type + diag) ========
    async function doFetch(url, options={}){
      const opts = Object.assign({ headers:{}, cache:'no-store' }, options);
      if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
      const r = await fetch(url, opts);
      if(!r.ok){ const txt = await r.text().catch(()=> ''); const err = new Error(`${opts.method||'GET'} ${url} => ${r.status} ${r.statusText} ${txt}`); err.status=r.status; throw err; }
      return r;
    }
    async function getJSON(path){ const r = await doFetch(`${DB_URL}/${path}.json`); return r.json(); }
    async function putJSON(path,val){ const r = await doFetch(`${DB_URL}/${path}.json`, {method:'PUT', body: JSON.stringify(val)}); return r.json(); }
    async function patchJSON(path,obj){ const r = await doFetch(`${DB_URL}/${path}.json`, {method:'PATCH', body: JSON.stringify(obj)}); return r.json(); }

    // ======== Utils ========
    const isValidKey = (k)=> /^\d+$/.test(String(k));
    const isFiniteId = (id)=> Number.isFinite(id) && id>=0;
    const now = ()=> Date.now();

    // ======== CSV ========
    function toSemicolonCSV(rows){
      const esc=(v)=>{ if(v==null) v=''; v=String(v); if(/[";\n]/.test(v)){ return '"'+v.replace(/"/g,'""')+'"'; } return v; };
      const header=['tsa','sku','unidades','ok','comentario'].join(';');
      const body = rows
        .filter(r=> (r.tsa && String(r.tsa).trim()) || (r.sku && String(r.sku).trim())) // evita filas vac√≠as
        .map(r=>[ esc(r.tsa), esc(r.sku), String(r.unidades??0), String(r.ok??0), esc(r.comentario||'') ].join(';'));
      return [header,...body].join('\n');
    }

    // ======== Parse/Build desde servidor ========
    function buildStateFromFirebase(datosObj, metaName){
      const rows=[]; if(!datosObj) datosObj={};
      const keys = Object.keys(datosObj);
      const numKeys = keys.filter(isValidKey).sort((a,b)=> Number(a)-Number(b));
      const map = new Map();
      for(const k of numKeys){
        const r = datosObj[k]||{};
        const tsa = r.tsa || '';
        const sku = normalizeSkuInput(r.sku||'');
        const unidades = Number(String(r.unidades??'0').replace(',','.'))||0;
        let ok = Number(r.ok); ok = (ok===0||ok===1||ok===2)? ok : 0;
        const comentario = r.comentario || '';
        const {t,s,a} = splitTSA(tsa);
        const row = { id:Number(k), tsa, t, s, a, sku, unidades, ok, comentario };
        rows.push(row);
        map.set(row.id, row);
      }
      state.rows = rows;
      state.map = map;
      state.filename = metaName ? (metaName + '.txt') : 'reparto_actual.txt';
      fileNote.innerHTML = `Fuente: Firebase Realtime Database (<code>${NODE}</code>) ‚Äî <b>Auto‚Äësync</b> ‚Äî <b>${rows.length}</b> filas`;
    }

    // ======== SKU & TSA helpers ========
    function formatSkuDisplay(value){ let clean = String(value||'').replace(/\D/g, ''); if (clean.length > 13) clean = clean.substring(0, 13); let formatted = ''; const parts = [1,4,3,3,2]; let index=0, position=0; for (let i=0;i<clean.length;i++){ if (index<parts.length){ formatted+=clean[i]; position++; if (position===parts[index]){ formatted+='/'; index++; position=0; } } } while(index<parts.length){ const remaining = parts[index]-position; formatted += '_'.repeat(remaining); if(index<parts.length-1) formatted+='/'; index++; position=0; } return formatted; }
    function normalizeSkuInput(value){ if(!value) return ''; let clean = String(value).replace(/\D/g,''); if(clean.length > 13) clean = clean.substring(0,13); if(clean.length===13 && /^\d+$/.test(clean)){ return clean.replace(/^(\d)(\d{4})(\d{3})(\d{3})(\d{2})$/, '$1/$2/$3/$4/$5'); } return clean; }
    function splitTSA(tsa){ const parts = String(tsa==null ? '' : tsa).split('/'); const t = parts[0] || ''; const s = parts[1] || ''; const a = parts[2] || ''; return { t, s, a }; }

    // ======== M√©tricas y renders ========
    function formatInt(n){ return new Intl.NumberFormat('es-ES').format(n); }
    function recomputeMetrics(){ const pendingRows = state.rows.filter(r=>r.ok===0); const tsaPending = new Set(pendingRows.map(r=>r.tsa).filter(Boolean)); const skuPending = new Set(pendingRows.map(r=>r.sku).filter(Boolean)); const unitsPending = pendingRows.reduce((acc,r)=>acc + (Number(r.unidades)||0), 0); m_tsa.innerHTML = `${formatInt(tsaPending.size)} <span class="tiny">tsa's pendientes</span>`; m_sku.innerHTML = `${formatInt(skuPending.size)} <span class="tiny">sku's pendientes</span>`; m_units.innerHTML = `${formatInt(unitsPending)} <span class="tiny">unidades pendientes</span>`; renderPendingSkuSelect(skuPending); }
    function renderPendingSkuSelect(skuSet){ const select = $('#pendingSkuSelect'); const currentValue = select.value; select.innerHTML = '<option value="">Selecciona un SKU pendiente...</option>'; const list = Array.from(skuSet).filter(Boolean).sort((a,b)=> (a||'').localeCompare(b||'', undefined, {numeric:true}) ); list.forEach(sku=>{ const option=document.createElement('option'); option.value=sku; option.textContent=sku; select.appendChild(option); }); if(currentValue && list.includes(currentValue)) select.value=currentValue; }

    // ======== Escritura (SEGURO: nunca reemplazar filas enteras) ========
    async function writeField(rowId, key, value){
      if(!isFiniteId(rowId)) return;
      const patch = {}; patch[key] = value; patch['_v'] = now();
      // PATCH al nodo de la fila (merge a nivel de campo)
      try{ await patchJSON(`datos/${rowId}`, patch); }
      catch(e){
        console.warn('PATCH fall√≥; PUT por campo‚Ä¶', e);
        try{ await putJSON(`datos/${rowId}/${key}`, value); await putJSON(`datos/${rowId}/_v`, now()); }
        catch(e2){ console.error('PUT por campo fall√≥', e2); }
      }
    }

    async function writeManyOk(ids, value){
      const valid = (ids||[]).filter(isFiniteId);
      if(!valid.length) return;
      const t = now();
      // ‚ö†Ô∏è Uso de rutas punteadas para MULTI-PATH UPDATE.
      // As√≠ solo actualizamos ok y _v, sin sobrescribir el resto de campos de cada fila.
      const multi = {};
      valid.forEach(id=>{ multi[`${id}/ok`] = value; multi[`${id}/_v`] = t; });
      try{
        await patchJSON('datos', multi); // PATCH con rutas punteadas
      }catch(e){
        console.warn('PATCH multi fall√≥, fallback a PATCH por fila‚Ä¶', e);
        for(const id of valid){
          try{ await patchJSON(`datos/${id}`, { ok:value, _v:t }); }
          catch(e2){
            console.warn('PATCH por fila fall√≥, fallback a PUT por campo‚Ä¶', id, e2);
            try{ await putJSON(`datos/${id}/ok`, value); await putJSON(`datos/${id}/_v`, t); }
            catch(e3){ console.error('PUT por campo fall√≥', id, e3); }
          }
        }
      }
    }

    async function writeManyComment(tsaRows, comment){
      const valid = tsaRows.map(r=>r.id).filter(isFiniteId);
      if(!valid.length) return;
      const t = now();
      const multi = {};
      valid.forEach(id=>{ multi[`${id}/comentario`] = comment; multi[`${id}/_v`] = t; });
      try{ await patchJSON('datos', multi); }
      catch(e){
        console.warn('PATCH multi comentario fall√≥, fallback a PATCH por fila‚Ä¶', e);
        for(const id of valid){
          try{ await patchJSON(`datos/${id}`, { comentario:comment, _v:t }); }
          catch(e2){ try{ await putJSON(`datos/${id}/comentario`, comment); await putJSON(`datos/${id}/_v`, t); }catch(e3){ console.error('PUT comentario por campo fall√≥', id, e3); } }
        }
      }
    }

    // ======== Checkbox tri-estado ========
    function createTriStateCheckbox(initialState, rowId){
      const checkbox=document.createElement('div');
      checkbox.className=`tri-state-checkbox state-${initialState}`;
      checkbox.dataset.state=initialState;
      checkbox.dataset.rowid=rowId;
      checkbox.tabIndex=0;
      checkbox.addEventListener('click',async function(e){ e.preventDefault(); const cs=parseInt(this.dataset.state); if(cs===2) return; const ns = cs===0?1:0; await updateCheckboxState(this, ns); });
      checkbox.addEventListener('dblclick',async function(e){ e.preventDefault(); const cs=parseInt(this.dataset.state); if(cs===2){ await updateCheckboxState(this,0);} else { await updateCheckboxState(this,2);} });
      checkbox.addEventListener('keydown',async function(e){ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); const cs=parseInt(this.dataset.state); if(cs===2) return; const ns = cs===0?1:0; await updateCheckboxState(this, ns); } else if(e.key==='2'){ e.preventDefault(); await updateCheckboxState(this,2);} });
      return checkbox;
    }
    async function updateCheckboxState(checkbox, newState){
      const rowId=parseInt(checkbox.dataset.rowid);
      const row=state.map.get(rowId) || state.rows.find(x=>x.id===rowId);
      if(row){ row.ok=newState; checkbox.dataset.state=newState; checkbox.className=`tri-state-checkbox state-${newState}`; recomputeMetrics(); renderRepaso(); if(skuSearch.value) onSkuSearch(); await writeField(rowId, 'ok', newState); }
    }

    function getTsaStatusIcon(tsaRows){ const hasState0 = tsaRows.some(r=>r.ok===0); const hasState1 = tsaRows.some(r=>r.ok===1); const allState2 = tsaRows.every(r=>r.ok===2); if(hasState0) return 'üî¥'; else if(allState2) return 'üü¢'; else if(hasState1) return 'üü†'; return 'üî¥'; }

    function createTsaToggleButton(tsa, tsaRows){ const button=document.createElement('button'); button.className='tsa-toggle-btn'; button.dataset.tsa=tsa; button.tabIndex=0; const allState0=tsaRows.every(r=>r.ok===0); const allState1=tsaRows.every(r=>r.ok===1); const allState2=tsaRows.every(r=>r.ok===2); let currentState='mixed', buttonText='Revisar'; if(allState0){ currentState='0'; buttonText='FALTA'; } else if(allState1){ currentState='1'; buttonText='PICK OK'; } else if(allState2){ currentState='2'; buttonText='DP OK'; } button.dataset.state=currentState; button.className=`tsa-toggle-btn state-${currentState}`; button.textContent=buttonText; let clickTimer=null; button.addEventListener('click',async function(e){ e.preventDefault(); if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; return; } clickTimer=setTimeout(async()=>{ clickTimer=null; await handleTsaSingleClick(this, tsa); },300); }); button.addEventListener('dblclick',async function(e){ e.preventDefault(); if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; } await handleTsaDoubleClick(this, tsa); }); button.addEventListener('keydown',async function(e){ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); await handleTsaSingleClick(this, tsa); } else if(e.key==='2'){ e.preventDefault(); const cs=this.dataset.state; const ns = cs==='2'?'0':'2'; await applyTsaState(tsa, parseInt(ns)); updateTsaButtonState(this, tsa); } }); return button; }
    async function handleTsaSingleClick(button, tsa){ const cs=button.dataset.state; if(cs==='2') return; const ns = cs==='0'?1:0; await applyTsaState(tsa, ns); updateTsaButtonState(button, tsa); }
    async function handleTsaDoubleClick(button, tsa){ const cs=button.dataset.state; if(cs==='2'){ await applyTsaState(tsa,0);} else { await applyTsaState(tsa,2);} updateTsaButtonState(button, tsa); }

    async function applyTsaState(tsa, newState){
      const tsaRows=state.rows.filter(r=>r.tsa===tsa);
      tsaRows.forEach(r=>{ r.ok=newState; });
      recomputeMetrics(); renderRepaso(); if(skuSearch.value) onSkuSearch();
      const ids = tsaRows.map(r=>r.id).filter(isFiniteId);
      await writeManyOk(ids, newState);
      toast(`TSA ${tsa} actualizado a estado ${newState}`);
    }
    function updateTsaButtonState(button, tsa){ const tsaRows=state.rows.filter(r=>r.tsa===tsa); const allState0=tsaRows.every(r=>r.ok===0); const allState1=tsaRows.every(r=>r.ok===1); const allState2=tsaRows.every(r=>r.ok===2); let ns='mixed', bt='TSA (mix)'; if(allState0){ ns='0'; bt='TSA (0)'; } else if(allState1){ ns='1'; bt='TSA (1)'; } else if(allState2){ ns='2'; bt='TSA (2)'; } button.dataset.state=ns; button.className=`tsa-toggle-btn state-${ns}`; button.textContent=bt; }

    async function updateTsaComment(tsa, newComment){
      const tsaRows=state.rows.filter(r=>r.tsa===tsa);
      tsaRows.forEach(r=>{ r.comentario=newComment; });
      await writeManyComment(tsaRows, newComment);
      if(skuSearch.value) onSkuSearch();
    }
    async function updateRowComment(rowId, newComment){ if(!isFiniteId(rowId)) return; const row=state.map.get(rowId) || state.rows.find(r=>r.id===rowId); if(row){ row.comentario=newComment; await writeField(rowId,'comentario',newComment); updateTsaCommentDisplay(row.tsa); } }
    function updateTsaCommentDisplay(tsa){ const tsaRows=state.rows.filter(r=>r.tsa===tsa); const mergedComment=mergeTsaComment(tsaRows); $$(`.tsa-block[data-tsa="${cssEscape(tsa)}"] .tsa-comment`).forEach(input=>{ input.value=mergedComment; }); }

    function cssEscape(str){ return String(str).replace(/([\\:.])/g,'\\$1'); }

    function onSkuSearch(){ const q=normalizeSkuInput(skuSearch.value); const rows=state.rows.filter(r=>r.sku===q); const container=skuResults; if(!q || q.replace(/\D/g,'').length<13){ container.innerHTML='<div class="muted">Introduce un SKU completo (13 d√≠gitos) para ver sus l√≠neas pendientes.</div>'; return; } if(rows.length===0){ container.innerHTML = `<div>No hay l√≠neas para <b>${q}</b>.</div>`; return; }
      rows.sort((a,b)=> (a.tsa||'').localeCompare((b.tsa||'')) || (Number(b.unidades)||0) - (Number(a.unidades)||0));
      const pendingCount = rows.filter(r=>r.ok===0).length;
      const html = `
        <table>
          <thead><tr><th>tsa</th><th>uds</th><th>ok</th><th>comentario</th></tr></thead>
          <tbody>
            ${rows.map(r=>`
              <tr data-rowid="${r.id}" class="${r.ok!==0 ? 'row-ok':''}">
                <td><span class="tag">${r.tsa}</span></td>
                <td>${formatInt(r.unidades)}</td>
                <td><div class="tri-state-checkbox-container"></div></td>
                <td><input type="text" class="row-comment" value="${escapeHtml(r.comentario)}" placeholder="‚Äî" data-rowid="${r.id}" /></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="margin-top:10px" class="subtle">Pendientes para este SKU: <b>${pendingCount}</b></div>`;
      container.innerHTML = html;
      $$('#skuResults tbody tr').forEach(tr=>{ const id=Number(tr.dataset.rowid); const row=state.map.get(id) || state.rows.find(x=>x.id===id); const checkboxContainer=$('.tri-state-checkbox-container', tr); const cm=$('.row-comment', tr); const checkbox=createTriStateCheckbox(row.ok, id); checkboxContainer.appendChild(checkbox); let d; cm.addEventListener('input', ()=>{ clearTimeout(d); d=setTimeout(()=>{ updateRowComment(id, cm.value); updateTsaCommentDisplay(row.tsa); },200); }); }); }

    function getFilter(){ return { t:f_t.value.trim(), s:f_s.value.trim(), a:f_a.value.trim() }; }
    function passesFilter(row, filter){ if(filter.t && String(row.t)!==filter.t) return false; if(filter.s && String(row.s)!==filter.s) return false; if(filter.a && String(row.a)!==filter.a) return false; return true; }

    function renderRepaso(){ const filter=getFilter(); const rows=state.rows.filter(r=>passesFilter(r, filter)); const byTsa=new Map(); rows.forEach(r=>{ const key = r.tsa || ''; if(!byTsa.has(key)) byTsa.set(key, []); byTsa.get(key).push(r); }); const tsas = Array.from(byTsa.keys()).sort((a,b)=>{ const aParts=splitTSA(a); const bParts=splitTSA(b); const sComp=(aParts.s||'').localeCompare(bParts.s||'', undefined, {numeric:true}); if(sComp!==0) return sComp; const tComp=(aParts.t||'').localeCompare(bParts.t||'', undefined, {numeric:true}); if(tComp!==0) return tComp; return (aParts.a||'').localeCompare(bParts.a||'', undefined, {numeric:true}); }); if(tsas.length===0){ repaso.innerHTML = '<div class="muted">No hay resultados con el filtro actual.</div>'; return; }
      const parts=[]; for(const tsa of tsas){ const lines=byTsa.get(tsa).sort((a,b)=> (Number(b.unidades)||0) - (Number(a.unidades)||0)); const tsaStatus=getTsaStatusIcon(lines); const comentarioTsa=mergeTsaComment(lines); parts.push(`
          <div class="tsa-block" data-tsa="${tsa}">
            <div class="tsa-head">
              <div class="tsa-title"><span class="tag">${tsa}</span><h3>${tsaStatus}</h3></div>
              <div class="tsa-controls"><div class="tsa-button-container"></div><input type="text" class="tsa-comment" placeholder="Comentario para toda la tienda‚Ä¶" value="${escapeHtml(comentarioTsa)}" data-tsa="${tsa}" /></div>
            </div>
            <div class="tsa-body">
              <table>
                <thead><tr><th>sku</th><th>uds</th><th>ok</th><th>comentario</th></tr></thead>
                <tbody>
                  ${lines.map(l=>`
                    <tr data-rowid="${l.id}" class="${l.ok!==0 ? 'row-ok':''}">
                      <td><span class="tag">${l.sku}</span></td>
                      <td>${formatInt(l.unidades)}</td>
                      <td><div class="tri-state-checkbox-container"></div></td>
                      <td><input type="text" class="row-comment" value="${escapeHtml(l.comentario)}" placeholder="‚Äî" data-rowid="${l.id}" /></td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>`); }
      repaso.innerHTML = parts.join('');
      $$('.tsa-block').forEach(block=>{ const tsa=block.dataset.tsa; const tsaRows=state.rows.filter(r=>r.tsa===tsa); const tsaButtonContainer=$('.tsa-button-container', block); const tsaButton=createTsaToggleButton(tsa, tsaRows); tsaButtonContainer.appendChild(tsaButton); const tsaComment=$('.tsa-comment', block); let d; tsaComment.addEventListener('input', ()=>{ clearTimeout(d); d=setTimeout(()=>{ updateTsaComment(tsa, tsaComment.value); $$(`.tsa-block[data-tsa="${cssEscape(tsa)}"] .row-comment`).forEach(input=>{ input.value = tsaComment.value; }); if(skuSearch.value) onSkuSearch(); },200); }); $$('.tsa-body tbody tr', block).forEach(tr=>{ const id=Number(tr.dataset.rowid); const row=state.map.get(id) || state.rows.find(x=>x.id===id); const checkboxContainer=$('.tri-state-checkbox-container', tr); const cm=$('.row-comment', tr); const checkbox=createTriStateCheckbox(row.ok, id); checkboxContainer.appendChild(checkbox); let d; cm.addEventListener('input', ()=>{ clearTimeout(d); d=setTimeout(()=>{ updateRowComment(id, cm.value); updateTsaCommentDisplay(tsa); },200); }); }); }); }

    function mergeTsaComment(lines){ const comments=lines.map(l=>l.comentario).filter(c=>c && c.trim().length>0); if(comments.length===0) return ''; const first=comments[0]; if(comments.every(c=>c===first)) return first; return ''; }
    function escapeHtml(unsafe){ return String(unsafe||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

    // ======== Reset column OK ========
    function updateResetSlider(){ const value=parseInt(resetSlider.value); resetCountdown.textContent = `${value}%`; if(value===100){ btnReset.disabled=false; startResetCountdown(5); } else { btnReset.disabled=true; resetCountdown.textContent=''; if(value<100){ resetSlider.value=0; } } }
    function onSliderChange(){ if(parseInt(resetSlider.value)!==100){ resetSlider.value=0; updateResetSlider(); } }
    let resetTimer=null; function startResetCountdown(seconds){ clearInterval(resetTimer); let left=seconds; resetCountdown.textContent=`Bot√≥n activo ${left}s`; resetTimer=setInterval(()=>{ left-=1; if(left<=0){ clearInterval(resetTimer); btnReset.disabled=true; resetSlider.value=0; resetCountdown.textContent=''; } else { resetCountdown.textContent=`Bot√≥n activo ${left}s`; } },1000); }
    async function doResetOk(){ if(btnReset.disabled) return; if(!confirm('¬øEst√°s seguro de que quieres resetear la columna OK? Esto marcar√° todas las l√≠neas como pendientes (estado 0).')) return; state.rows.forEach(r=>{ r.ok=0; }); resetSlider.value=0; updateResetSlider(); recomputeMetrics(); renderRepaso(); if(skuSearch.value) onSkuSearch(); const ids = state.rows.map(r=>r.id).filter(isFiniteId); await writeManyOk(ids, 0); toast('Columna OK reseteada y sincronizada'); }

    // ======== Carga inicial + Polling ========
    async function initialLoad(){ try{ fileNote.textContent='Conectando a Firebase‚Ä¶'; const [meta, datos] = await Promise.all([getJSON('meta'), getJSON('datos')]); buildStateFromFirebase(datos||{}, meta && meta.nombre); state.lastHash = JSON.stringify(datos||{}); fileNote.innerHTML='Fuente: Firebase Realtime Database (<code>actual</code>) ‚Äî <b>Auto‚Äësync</b>'; renderAll(); } catch(err){ console.error(err); alert('Error al cargar desde Firebase: '+err.message); fileNote.textContent='Error al conectar con Firebase'; } }
    async function poll(){ try{ const [meta, datos] = await Promise.all([getJSON('meta'), getJSON('datos')]); const h = JSON.stringify(datos||{}); if(h !== state.lastHash){ state.lastHash = h; buildStateFromFirebase(datos||{}, meta && meta.nombre); renderAll(); } }catch(_){ /* ignora errores transitorios */ } }
    function startPolling(){ setInterval(poll, POLL_MS); }

    function renderAll(){ managingTitle.innerHTML = `Gestionando el cierre para <b>${escapeHtml(state.filename||'reparto_actual.txt')}</b>.`; recomputeMetrics(); renderRepaso(); onSkuSearch(); }

    function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.setAttribute('role','status'); t.style.position='fixed'; t.style.bottom='20px'; t.style.right='20px'; t.style.background='rgba(15,23,42,.95)'; t.style.border='1px solid #334155'; t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.boxShadow='var(--shadow)'; document.body.appendChild(t); setTimeout(()=> t.remove(), 2000); }

    // ======== Listeners ========
    btnSaveAs.addEventListener('click', ()=>{ const data=toSemicolonCSV(state.rows); downloadFile(data, state.filename? 'EDITADO_'+state.filename : 'descuadre_editado.txt'); toast('Descarga iniciada.'); });

    btnClearSku.addEventListener('click', clearSkuSearch);
    btnClearFilters.addEventListener('click', ()=>{ f_t.value=''; f_s.value=''; f_a.value=''; renderRepaso(); toast('Todos los filtros limpiados'); });

    skuSearch.addEventListener('input', ()=>{ updateSkuDisplay(); const clean=String(skuSearch.value||'').replace(/\D/g,''); if(clean.length===13){ setTimeout(()=> onSkuSearch(), 80); } });
    skuSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSkuSearch(); });
    pendingSkuSelect.addEventListener('change', function(){ if(this.value){ const cleanSku=String(this.value).replace(/\D/g,''); skuSearch.value=cleanSku; updateSkuDisplay(); onSkuSearch(); skuSearch.focus(); } });

    [f_t, f_s, f_a].forEach(el=> el.addEventListener('input', ()=>{ renderRepaso(); }));

    resetSlider.addEventListener('input', updateResetSlider);
    resetSlider.addEventListener('change', onSliderChange);
    btnReset.addEventListener('click', doResetOk);

    // ======== Download helper ========
    function downloadFile(text, filename){ const blob = new Blob([text], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename||'descuadre.txt'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); }

    // Init
    function updateSkuDisplay(){ const rawValue = skuSearch.value||''; const displayValue = formatSkuDisplay(rawValue); skuFormattedDisplay.textContent = displayValue; const clean = rawValue.replace(/\D/g,''); if (clean.length === 14) { const corrected = clean.substring(0,13); skuSearch.value = corrected; updateSkuDisplay(); } }
    function clearSkuSearch(){ skuSearch.value=''; updateSkuDisplay(); skuResults.innerHTML='<div class="muted">Introduce un SKU completo (13 d√≠gitos) para ver sus l√≠neas pendientes.</div>'; pendingSkuSelect.value=''; toast('Campo SKU limpiado'); }

    updateSkuDisplay();
    initialLoad().then(startPolling);
  })();
  </script>
</body>
<footer style="text-align:center; padding:10px; font-size:14px; color:#555;">
  V2.0 ¬© 2025 Automatismos. Todos los reservados derechos.
</footer>
</html>
